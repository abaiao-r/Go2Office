@startuml session-aggregation
!theme plain

start
:Get all presence\nrecords for date;

partition "Pair Entry/Exit" {
    :Sort by timestamp;
    :Match entries\nwith exits;
}

partition "Calculate Each Session" {
    repeat
        :Get session\nentry and exit;
        :Apply work hours\nwindow (7 AM - 7 PM);
        :Calculate\nsession hours;
        :Add to total;
    repeat while (more sessions?)
}

partition "Apply Daily Cap" {
    if (Total > 10 hours?) then (yes)
        :Cap at 10 hours;
    else (no)
        :Keep actual total;
    endif
}

:Save aggregated\ndaily entry;
stop

note right
  Example:
  Session 1: 8:30 AM - 12:00 PM = 3.5h
  Session 2: 1:00 PM - 2:00 PM = 1.0h
  Session 3: 2:30 PM - 6:00 PM = 3.5h
  Total: 8.0 hours
end note

@enduml

